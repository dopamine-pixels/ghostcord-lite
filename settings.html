<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Ghostcord Settings</title>
    <style>
      body { 
        font-family: system-ui, sans-serif; 
        margin: 16px;
        background: #2f3136;
        color: #dcddde;
      }
      h2 {
        color: #fff;
        margin-bottom: 20px;
      }
      .row { 
        display:flex; 
        align-items:center; 
        justify-content:space-between; 
        gap: 8px; 
        margin: 10px 0; 
      }
      label {
        color: #b9bbbe;
      }
      input[type="text"], textarea { 
        width: 100%; 
        padding: 8px;
        background: #40444b;
        border: 1px solid #202225;
        color: #dcddde;
        border-radius: 3px;
      }
      .row input[type="text"] { 
        flex: 1; 
        width: auto; 
      }
      textarea { 
        resize: vertical;
        font-family: 'Consolas', 'Monaco', monospace;
      }
      button { 
        padding: 8px 12px;
        background: #5865f2;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-weight: 500;
      }
      button:hover {
        background: #4752c4;
      }
      button#close {
        background: #4f545c;
      }
      button#close:hover {
        background: #686d73;
      }
      .small { 
        opacity: 0.75; 
        font-size: 12px;
        color: #72767d;
        margin: 4px 0;
      }
      hr {
        border: none;
        border-top: 1px solid #4f545c;
        margin: 20px 0;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        display: none;
      }
      .status.success {
        background: #3ba55d;
        color: white;
      }
      .status.error {
        background: #ed4245;
        color: white;
      }
    </style>
  </head>
  <body>
    <h2>âš¡ Ghostcord Lite Settings</h2>

    <div id="status" class="status"></div>

    <div class="row">
      <label>Enable blockers (analytics, trackers)</label>
      <input id="enable_blockers" type="checkbox" />
    </div>

    <div class="row">
      <label>Enable performance CSS (removes animations)</label>
      <input id="enable_perf_css" type="checkbox" />
    </div>

    <div class="row">
      <label>Enable Vencord mode (experimental)</label>
      <input id="enable_vencord" type="checkbox" />
    </div>

    <hr />

    <div class="row">
      <label>Enable custom theme</label>
      <input id="enable_theme" type="checkbox" />
    </div>

    <div>
      <label>Theme file path (.theme.css)</label>
      <div class="row">
        <input id="theme_path" type="text" placeholder="C:\Themes\MyTheme.theme.css" />
        <button id="theme_pick" type="button">Browse...</button>
      </div>
      <p class="small">Select a BetterDiscord theme file from your computer</p>
    </div>

    <div>
      <label>Direct CSS override (takes priority over file)</label>
      <textarea id="theme_css" rows="8" placeholder="/* Paste custom CSS here */"></textarea>
      <p class="small">Any CSS pasted here will override the theme file setting above</p>
    </div>

    <hr />

    <div class="row">
      <button id="save">ðŸ’¾ Save & Apply</button>
      <button id="close">Close</button>
    </div>

    <script type="module">
      // Import from Tauri
      const { invoke } = window.__TAURI__.core;
      const { getCurrentWindow } = window.__TAURI__.window;

      const $ = (id) => document.getElementById(id);

      function showStatus(message, isError = false) {
        const status = $('status');
        status.textContent = message;
        status.className = `status ${isError ? 'error' : 'success'}`;
        status.style.display = 'block';
        
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      }

      async function load() {
        try {
          const cfg = await invoke('load_config');
          
          $('enable_blockers').checked = !!cfg.enable_blockers;
          $('enable_perf_css').checked = !!cfg.enable_perf_css;
          $('enable_vencord').checked = !!cfg.enable_vencord;
          $('enable_theme').checked = !!cfg.enable_theme;
          $('theme_path').value = cfg.theme_path || '';
          $('theme_css').value = cfg.theme_css || '';
          
          console.log('[Settings] Config loaded:', cfg);
        } catch (err) {
          console.error('[Settings] Failed to load config:', err);
          showStatus('Failed to load settings: ' + err, true);
        }
      }

      async function save() {
        try {
          const cfg = {
            enable_blockers: $('enable_blockers').checked,
            enable_perf_css: $('enable_perf_css').checked,
            enable_vencord: $('enable_vencord').checked,
            enable_theme: $('enable_theme').checked,
            theme_path: $('theme_path').value.trim() || null,
            theme_css: $('theme_css').value.trim() || null
          };
          
          await invoke('save_config', { cfg });
          await invoke('apply_config_to_main', { cfg });
          
          console.log('[Settings] Config saved:', cfg);
          showStatus('âœ“ Settings saved and applied!');
        } catch (err) {
          console.error('[Settings] Failed to save config:', err);
          showStatus('Failed to save: ' + err, true);
        }
      }

      $('theme_pick').addEventListener('click', async () => {
        try {
          const picked = await invoke('pick_theme_file');
          if (picked) {
            $('theme_path').value = picked;
            console.log('[Settings] Theme file selected:', picked);
          }
        } catch (err) {
          console.error('[Settings] Failed to pick file:', err);
          showStatus('Failed to select file: ' + err, true);
        }
      });

      $('save').addEventListener('click', save);
      
      $('close').addEventListener('click', async () => {
        try {
          await getCurrentWindow().hide();
        } catch (err) {
          console.error('[Settings] Failed to close window:', err);
        }
      });

      // Load config on startup
      load();
      
      console.log('[Ghostcord Settings] Ready');
    </script>
  </body>
</html>
